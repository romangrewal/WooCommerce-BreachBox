---
- name: Install Vulnerable WordPress 5.0 and WooCommerce 3.4.0
  hosts: localhost
  become: yes
  vars:
    wp_db_name: "wordpress_db"
    wp_db_user: "wp_user"
    wp_db_pass: "InsecurePassword123"
    wp_root_dir: "/var/www/html"

  tasks:
    ## 1. INFRASTRUCTURE & PHP-APACHE INTEGRATION
    - name: Install Stack (Apache, MariaDB, PHP 7.0)
      apt:
        name:
          - software-properties-common
          - python-mysqldb
          - apache2
          - mariadb-server
          - php7.0
          - php7.0-mysql
          - php-imagick
          - unzip
          - libapache2-mod-php7.0
        state: present
        update_cache: yes

    - name: Force Overwrite Apache VirtualHost for WordPress
      become: yes
      copy:
        dest: /etc/apache2/sites-available/000-default.conf
        content: |
          <VirtualHost *:80>
              ServerAdmin webmaster@localhost
              DocumentRoot {{ wp_root_dir }}

              <Directory {{ wp_root_dir }}>
                  Options Indexes FollowSymLinks
                  AllowOverride All
                  Require all granted
              </Directory>

              ErrorLog ${APACHE_LOG_DIR}/error.log
              CustomLog ${APACHE_LOG_DIR}/access.log combined
          </VirtualHost>

    - name: Manually Create .htaccess with WordPress Rewrite Rules
      copy:
        dest: "{{ wp_root_dir }}/.htaccess"
        content: |
          # BEGIN WordPress
          <IfModule mod_rewrite.c>
          RewriteEngine On
          RewriteBase /
          RewriteRule ^index\.php$ - [L]
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule . /index.php [L]
          </IfModule>
          # END WordPress
        owner: www-data
        group: www-data
        mode: '0666'

    - name: Configure Web Server for WordPress
      shell: |
        a2enmod rewrite
        a2enmod php7.0
      notify: restart apache

    - name: Set PHP Priority
      lineinfile:
        path: /etc/apache2/mods-enabled/dir.conf
        regexp: 'DirectoryIndex index.html index.cgi index.pl index.php index.xhtml index.htm'
        line: 'DirectoryIndex index.php index.html index.cgi index.pl index.xhtml index.htm'
      notify: restart apache

    - name: Start Services
      service:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop: [apache2, mysql]

    ## 2. DATABASE CONFIGURATION
    - name: Create MySQL Database and User
      mysql_db:
        name: "{{ wp_db_name }}"
        state: present
        login_unix_socket: /var/run/mysqld/mysqld.sock

    - name: Create MySQL User
      mysql_user:
        name: "{{ wp_db_user }}"
        password: "{{ wp_db_pass }}"
        priv: "{{ wp_db_name }}.*:ALL"
        host: "localhost"
        login_unix_socket: /var/run/mysqld/mysqld.sock

    ## 3. DOWNLOAD & DEPLOY WP + PLUGINS
    - name: Download WP and Core Plugins
      unarchive:
        src: "{{ item.url }}"
        dest: "{{ item.dest }}"
        remote_src: yes
      loop:
        - { url: 'https://wordpress.org/wordpress-5.0.tar.gz', dest: '/tmp' }
        - { url: 'https://downloads.wordpress.org/plugin/woocommerce.3.4.0.zip', dest: '/tmp' }
        - { url: 'https://downloads.wordpress.org/plugin/contact-form-7.5.0.3.zip', dest: '/tmp' }
        - { url: 'https://downloads.wordpress.org/plugin/wp-statistics.12.6.6.zip', dest: '/tmp' }

    - name: Deploy Files to Web Root
      shell: |
        cp -r /tmp/wordpress/* {{ wp_root_dir }}/
        cp -r /tmp/woocommerce {{ wp_root_dir }}/wp-content/plugins/
        cp -r /tmp/contact-form-7 {{ wp_root_dir }}/wp-content/plugins/
        cp -r /tmp/wp-statistics {{ wp_root_dir }}/wp-content/plugins/
        chown -R www-data:www-data {{ wp_root_dir }}

    - name: Create mu-plugins directory
      file:
        path: "{{ wp_root_dir }}/wp-content/mu-plugins"
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Force Mail Success for Lab Environment
      copy:
        dest: "{{ wp_root_dir }}/wp-content/mu-plugins/force-mail-success.php"
        content: |
          <?php
          /* Description: Forces WordPress to return true for mail attempts in a lab setting.
          */
          add_filter('pre_wp_mail', function($return, $atts) {
              return true;
          }, 10, 2);
        owner: www-data
        group: www-data

    - name: Configure wp-config.php
      shell: |
        cp {{ wp_root_dir }}/wp-config-sample.php {{ wp_root_dir }}/wp-config.php
        sed -i "s/database_name_here/{{ wp_db_name }}/" {{ wp_root_dir }}/wp-config.php
        sed -i "s/username_here/{{ wp_db_user }}/" {{ wp_root_dir }}/wp-config.php
        sed -i "s/password_here/{{ wp_db_pass }}/" {{ wp_root_dir }}/wp-config.php
        echo "define( 'AUTOMATIC_UPDATER_DISABLED', true );" >> {{ wp_root_dir }}/wp-config.php
        echo "define( 'WP_AUTO_UPDATE_CORE', false );" >> {{ wp_root_dir }}/wp-config.php
        # Force CF7 to bypass mail server verification (crucial for labs without SMTP)
        echo "define( 'WPCF7_LOAD_JS', false );" >> {{ wp_root_dir }}/wp-config.php

    ## 4. WP-CLI CONFIGURATION & FINAL SYNC
    - name: Setup WP-CLI
      get_url:
        url: https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
        dest: /usr/local/bin/wp
        mode: '0755'

    - name: WP Core Install
      command: >
        wp core install
        --url="http://{{ ansible_eth1.ipv4.address }}"
        --title="Vulnerable Store"
        --admin_user="admin"
        --admin_password="P@ssword123"
        --admin_email="admin@example.com"
        --path="{{ wp_root_dir }}"
        --allow-root

    - name: Create Low-Privilege Contributor User
      command: wp user create victim victim@example.com --role=contributor --user_pass=Victim123 --allow-root --path={{ wp_root_dir }}

    - name: Final WooCommerce Mapping, Configuration, and Permalink Flush
      shell: |
        # 1. Base Setup & Activation
        wp plugin activate woocommerce contact-form-7 wp-statistics --allow-root --path={{ wp_root_dir }}
        wp option update woocommerce_setup_status "completed" --allow-root --path={{ wp_root_dir }}
        wp wc tool run install_pages --allow-root --user=admin --path={{ wp_root_dir }}
        wp option update wp_statistics_cache_plugin "1" --allow-root --path={{ wp_root_dir }}

        # 2. Map IDs (Shop, Cart, etc.)
        for p in shop cart checkout my-account; do
          ID=$(wp post list --post_type=page --name="$p" --field=ID --allow-root --path={{ wp_root_dir }})
          [ "$p" = "shop" ] && OPT="woocommerce_shop_page_id" || OPT="woocommerce_"${p}"_page_id"
          [ "$p" = "my-account" ] && OPT="woocommerce_myaccount_page_id"
          wp option update "$OPT" "$ID" --allow-root --path={{ wp_root_dir }}
        done

        # 3. DIRECT SQL INJECTION (Payments Fix)
        mysql -u {{ wp_db_user }} -p{{ wp_db_pass }} {{ wp_db_name }} -e "INSERT IGNORE INTO wp_woocommerce_shipping_zone_methods (zone_id, method_id, method_order, is_enabled) VALUES (0, 'cheque', 1, 1), (0, 'free_shipping', 2, 1);"

        # 4. Gateway & Location Config
        wp option update woocommerce_gateway_order 'a:1:{s:6:"cheque";i:0;}' --allow-root --path={{ wp_root_dir }}
        wp option update woocommerce_cheque_settings '{"enabled":"yes","title":"Check payments","description":"Lab Payment","instructions":"N/A"}' --format=json --allow-root --path={{ wp_root_dir }}
        wp option update woocommerce_allowed_countries 'all' --allow-root --path={{ wp_root_dir }}
        wp option update woocommerce_ship_to_countries 'all' --allow-root --path={{ wp_root_dir }}
        wp option update woocommerce_default_customer_address 'base' --allow-root --path={{ wp_root_dir }}
        # Change currency to USD
        wp option update woocommerce_currency 'USD' --allow-root --path={{ wp_root_dir }}
        # Set currency position to left (optional, standard for USD)
        wp option update woocommerce_currency_pos 'left' --allow-root --path={{ wp_root_dir }}

        # 5. Storefront Theme Setup
        wp theme install storefront --activate --allow-root --path={{ wp_root_dir }}
        SHOP_ID=$(wp post list --post_type=page --name=shop --field=ID --allow-root --path={{ wp_root_dir }})
        wp post update "$SHOP_ID" --page_template=template-homepage.php --allow-root --path={{ wp_root_dir }}
        wp option update show_on_front 'page' --allow-root --path={{ wp_root_dir }}
        wp option update page_on_front "$SHOP_ID" --allow-root --path={{ wp_root_dir }}
        wp widget reset sidebar-1 --allow-root --path={{ wp_root_dir }}

        # 6. Generate Store Products
        for i in {1..5}; do
          wp wc product create \
            --name="Store Item #$i" \
            --type="simple" \
            --regular_price="$((10 + i)).99" \
            --description="Testing object ID: $i" \
            --user=admin --allow-root --path={{ wp_root_dir }}
        done

        # 8. AUTOMATED CONTACT FORM CREATION (The Robust Way)
        FORM_TEMPLATE='<label> Your Name (required) [text* your-name] </label> <label> Your Email (required) [email* your-email] </label> <label> Subject [text your-subject] </label> <label> Your Message [textarea your-message] </label> [submit "Send"]'

        # Create the form post
        CF7_ID=$(wp post create --post_type=wpcf7_contact_form \
                       --post_title="Insecure Contact Form" \
                       --post_content="$FORM_TEMPLATE" \
                       --post_status=publish --porcelain --allow-root --path={{ wp_root_dir }})

        # CRITICAL: Set the metadata so CF7 recognizes the form fields
        wp post meta set $CF7_ID _form "$FORM_TEMPLATE" --allow-root --path={{ wp_root_dir }}

        # Set basic mail settings (needed for the plugin to consider the form "valid")
        wp post meta set $CF7_ID _mail '{"active":true,"subject":"Lab Inquiry","sender":"wordpress@lab.local","recipient":"admin@example.com","body":"From: [your-name] <[your-email]>\nSubject: [your-subject]\n\nMessage Body:\n[your-message]","additional_headers":"","attachments":"","use_html":false}' --format=json --allow-root --path={{ wp_root_dir }}

        # Create the Page and link the ID
        wp post create --post_type=page \
                       --post_title="Contact Us" \
                       --post_content='[contact-form-7 id="'$CF7_ID'" title="Insecure Contact Form"]' \
                       --post_status=publish --allow-root --path={{ wp_root_dir }}
        # Disable the domain validation check in the database
        wp option update wpcf7_validate_configuration "false" --allow-root --path={{ wp_root_dir }}
        # Set mail settings with a more "acceptable" sender format
        wp post meta set $CF7_ID _mail '{"active":true,"subject":"Lab Inquiry","sender":"admin@{{ ansible_eth1.ipv4.address }}","recipient":"admin@localhost","body":"[your-message]","additional_headers":"Reply-To: [your-email]","attachments":"","use_html":false}' --format=json --allow-root --path={{ wp_root_dir }}


        # 9. Nuclear Flush
        wp db query "DELETE FROM wp_options WHERE option_name LIKE '_transient_wc_ship_%' OR option_name LIKE '_transient_timeout_wc_ship_%';" --allow-root --path={{ wp_root_dir }}
        wp db query "TRUNCATE TABLE wp_woocommerce_sessions;" --allow-root --path={{ wp_root_dir }}
        wp transient delete --all --allow-root --path={{ wp_root_dir }}
        wp rewrite structure '/%postname%/' --hard --allow-root --path={{ wp_root_dir }}
        wp rewrite flush --hard --allow-root --path={{ wp_root_dir }}
      args:
        executable: /bin/bash

    - name: Set Vulnerable Permissions (PCI Violation Simulation)
      file:
        path: "{{ wp_root_dir }}"
        state: directory
        recurse: yes
        mode: '0777'

  handlers:
    - name: restart apache
      service:
        name: apache2
        state: restarted
